var map,lat=56.4572091,lng=-2.9784761,markers=[],months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"],PRCP="PRCP",ETpot="ETpot",ET="ET",selectLocationText="",formVariables={speiclass:"N",stones:1,plotLength:1,plotWidth:1,irrigations:{D:{rainfall:{},potential:{},transpiration:{}},N:{rainfall:{},potential:{},transpiration:{}},W:{rainfall:{},potential:{},transpiration:{}}},rainfall:{},potential:{},transpiration:{},locationLat:"",locationLong:""};function showWizardStep(t,e){var a=document.getElementById(t);if(a){var o=[].slice.call(document.querySelectorAll(".wizard__step"));o.length&&o.forEach(function(t,e){t.setAttribute("aria-hidden",!0)}),a.removeAttribute("aria-hidden"),e.preventDefault()}}function checkCanSelectCoords(){null!==formVariables.speiclass&&null!==formVariables.stones&&map.addListener("click",clickHandler)}function selectSpeiClass(t){var e=formVariables.speiclass;formVariables.speiclass=t?t.value:e,checkCanSelectCoords(),calculateResults()}function selectStones(t){formVariables.stones=t.value,checkCanSelectCoords()}function clearMarkers(){markers.forEach(function(t){t.setMap(null)}),markers=[]}function addMapMarker(t){clearMarkers(),markers.push(new google.maps.Marker({map:map,position:t.geometry.location}))}function setLocationTexts(){var t=[].slice.call(document.querySelectorAll("[data-location-text='true']"));t.length&&t.forEach(function(t,e){t.innerText=""!==selectLocationText?selectLocationText:"Selected location111"})}async function clickHandler(t){var e=t.latLng.lat(),a=t.latLng.lng(),o={lat:e,lng:a};(new google.maps.Geocoder).geocode({location:o},function(t,e){"OK"===e&&t[0]&&(selectLocationText=t[0].formatted_address,setLocationTexts())}),addMapMarker({geometry:{location:t.latLng}}),updatePlotSize();try{var n=await getNearest(a,e).catch(t=>{throw t});if(!n.length)return noResults();enableCalculateButton(),formVariables.locationLat=e,formVariables.locationLong=a,window.plots=n,formVariables.irrigations.D=filterData("D"),formVariables.irrigations.N=filterData("N"),formVariables.irrigations.W=filterData("W")}catch(t){}}function filterData(t){const e=window.plots.filter(e=>e.SPEICLASS===t);return{rainfall:collateMonths(e.filter(t=>t.Variable===PRCP)),potential:collateMonths(e.filter(t=>t.Variable===ETpot)),transpiration:collateMonths(e.filter(t=>t.Variable===ET))}}function enableCalculateButton(){var t=document.getElementById("calculate");t.disabled=!1,t.addEventListener("click",function(t){updatePlotSize(),setPlotSizeTexts(),selectSpeiClass(),showWizardStep("step-3",t)})}function calculateMonthsIrrigation(t,e,a){return months.map(o=>{var n=a[o]>t[o]?e[o]-a[o]:0,r=n*(formVariables.plotLength*formVariables.plotWidth),i=document.getElementById(o.toLowerCase());i.querySelector(".results__item__irrigation").innerText=r.toFixed(2),n>0?i.classList.add("has-irrigation"):i.classList.remove("has-irrigation")})}function backToStep1(t){resetIrrigationControlButtons(),resetResultsTable(),showWizardStep("step-1",t)}function resetResultsTable(){months.map(t=>{var e=document.getElementById(t.toLowerCase());e.querySelector(".results__item__irrigation").innerText="",e.classList.remove("has-irrigation")})}function setPlotSizeTexts(){var t=[].slice.call(document.querySelectorAll("[data-plotsize-text='true']"));t.length&&t.forEach(function(t,e){t.innerText=(formVariables.plotLength*formVariables.plotWidth).toFixed(2)+"m";var a=document.createElement("sup");a.innerText="2",t.appendChild(a)})}function resetIrrigationControlButtons(){var t=[].slice.call(document.querySelectorAll("[data-irrigation-control='true']"));t.length&&t.forEach(function(t,e){var a=document.getElementById(t.getAttribute("aria-controls"));a&&a.setAttribute("aria-hidden",!0),t.setAttribute("aria-pressed",!1)})}function showIrrigationMonthData(t){var e=document.getElementById(t.target.getAttribute("aria-controls"));resetIrrigationControlButtons(),t.target.setAttribute("aria-pressed",!0),e.setAttribute("aria-hidden",!1)}function updatePlotSize(){var t=document.getElementById("plot-length"),e=document.getElementById("plot-width");t&&e&&(formVariables.plotLength=t.value,formVariables.plotWidth=e.value)}function collateMonths(t){var e={},a=t.length;return months.map(o=>{var n=t.map(t=>t[o]).reduce((t,e)=>parseInt(t)+parseInt(e),0);e[o]=n/a}),e}function calculateResults(){const t=formVariables.irrigations[formVariables.speiclass];calculateMonthsIrrigation(t.rainfall,t.potential,t.transpiration)}async function getNearest(t,e){try{return await fetch(`/points/nearest/${e}/${t}`).then(t=>t.json()).then(t=>{if(t.length){var e=t[0].GRIDID;return t.filter(t=>t.GRIDID===e)}return[]})}catch(t){noResults()}}function noResults(){setLocationTexts(),window.alert("Sorry, no water data is available for this location. Please try another location.")}function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:lat,lng:lng},mapTypeControl:!1,scaleControl:!0,zoomControl:!0,streetViewControl:!1,zoom:12});var t=document.getElementById("pac-input"),e=new google.maps.places.SearchBox(t);map.addListener("bounds_changed",function(){e.setBounds(map.getBounds())}),e.addListener("places_changed",function(){var t=e.getPlaces();if(0!==t.length){clearMarkers();var a=new google.maps.LatLngBounds;selectLocationText=t.length?"Nr. "+t[0].formatted_address:"Select location",t.forEach(function(t){t.geometry&&(t.geometry.viewport?a.union(t.geometry.viewport):a.extend(t.geometry.location))}),map.fitBounds(a)}else selectLocationText="Select location"}),checkCanSelectCoords(),setPlotSizeTexts()}export{initMap,showWizardStep,showIrrigationMonthData,selectSpeiClass,backToStep1};